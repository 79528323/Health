Index: app/src/main/java/com/gzhealthy/health/activity/ArticleHtmlActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.gzhealthy.health.activity;\n\nimport android.content.Context;\nimport android.content.Intent;\nimport android.graphics.BitmapFactory;\nimport android.os.Build;\nimport android.os.Bundle;\nimport android.text.TextUtils;\nimport android.util.Log;\nimport android.view.Gravity;\nimport android.view.KeyEvent;\nimport android.view.View;\nimport android.view.ViewGroup;\nimport android.webkit.ConsoleMessage;\nimport android.webkit.CookieManager;\nimport android.webkit.CookieSyncManager;\nimport android.webkit.WebChromeClient;\nimport android.webkit.WebSettings;\nimport android.webkit.WebView;\nimport android.webkit.WebViewClient;\nimport android.widget.ImageView;\nimport android.widget.LinearLayout;\nimport android.widget.ProgressBar;\nimport android.widget.RelativeLayout;\n\nimport com.gzhealthy.health.R;\nimport com.gzhealthy.health.activity.account.LoginActivity;\nimport com.gzhealthy.health.api.CallBack;\nimport com.gzhealthy.health.api.InsuranceApiFactory;\nimport com.gzhealthy.health.base.BaseAct;\nimport com.gzhealthy.health.model.ComModel;\nimport com.gzhealthy.health.model.NewsDetailModel;\nimport com.gzhealthy.health.model.NewsListModel;\nimport com.gzhealthy.health.share.ShareBean;\nimport com.gzhealthy.health.tool.HttpUtils;\nimport com.gzhealthy.health.tool.SPCache;\nimport com.gzhealthy.health.utils.DispUtil;\nimport com.gzhealthy.health.utils.ToastUtil;\nimport com.gzhealthy.health.utils.WechatPlatform;\nimport com.gzhealthy.health.widget.Html5WebView;\n\nimport java.io.File;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport rx.Observable;\n\nimport static org.litepal.crud.DataSupport.findFirst;\n\n/**\n * 资讯详情浏览\n */\npublic class ArticleHtmlActivity extends BaseAct {\n    private static final String TAG = \"Html5Activity\";\n    private final int REQUEST_CODE_CAMERA = 2;\n    private String mUrl, shareUrl;\n\n    private LinearLayout mLayout;\n    protected Html5WebView mWebView;\n    private ProgressBar pb;\n    protected String title, beanStr, beanStr2, idCode;\n    private Boolean isNeedRightIcon, isNeedSecondRightIcon, isHuize=false;\n    protected Bundle bundle;\n    private File cameraFile;\n    private String productCode = \"0\";\n    private ShareBean shareBean;\n\n    private boolean isSCUrl = true;\n\n    boolean firstVisitWXH5PayUrl = true;\n    private ImageView collectBtn;\n    private LinearLayout collectBg;\n//    private boolean isCollect = false;\n\n    @Override\n    protected void init(Bundle saveInstanceState) {\n        initView();\n    }\n\n    public void initView() {\n//        mImmersionBar.statusBarColor(R.color.white).barAlpha(0.5f).statusBarDarkFont(true).init();\n        setstatueColor(R.color.white);\n        setBarLeftIcon(R.mipmap.login_back, v -> {\n            goBack();\n        });\n        getCenterTextView().setTextColor(getResources().getColor(R.color.text_color_1));\n        getCenterTextView().setTextSize(18);\n\n//        bundle = getIntent().getBundleExtra(\"bundle\");\n//        boolean isNew = bundle.getBoolean(\"isNew\",false);\n//        if (bundle != null) {\n//            mUrl = bundle.getString(\"url\");\n//            Log.d(TAG, \"initView: \" + mUrl);\n//        } else {\n//            mUrl = \"www.baidu.com\";\n//        }\n//        title = bundle.getString(\"title\", \"\");\n//        beanStr = bundle.getString(\"beanStr\", \"\");\n//        beanStr2 = bundle.getString(\"beanStr2\", \"\");\n//        idCode = bundle.getString(\"idCode\", \"\");\n//        isNeedRightIcon = bundle.getBoolean(\"isNeedRightIcon\");\n//        isNeedSecondRightIcon = bundle.getBoolean(\"isNeedSecondRightIcon\");\n//        isHuize = bundle.getBoolean(\"isHuize\");\n//        Log.d(TAG, \"initView: \" + beanStr);\n//        Log.d(TAG, \"initView: \" + beanStr2);\n//        Log.d(TAG, \"initView: \" + idCode);\n\n\n\n//        setBarRighticon(R.mipmap.ic_details_sharet_bg);\n//        getIvRight().setOnClickListener(v -> {\n//            NewsListModel.DataBean bean = (NewsListModel.DataBean) getIntent().getSerializableExtra(\"NewsListModel\");\n//            WechatPlatform.shareMomentsURL(\n//                    this\n//                    ,getHtmlData(bean.getContent())\n//                    ,\"体安APP准备上线\"\n//                    ,\"体安（体安在手，健康我有\"\n//                    ,BitmapFactory.decodeResource(getResources(),R.mipmap.app_logo));\n////            WechatPlatform.shareImageSession(this,\n////                    \"体安在手，健康我有\", BitmapFactory.decodeResource(getResources(),R.mipmap.app_logo));\n//        });\n\n\n\n//        if (isNeedRightIcon) {\n//\n//        }\n//\n//        if (isNeedSecondRightIcon) {\n//            setBarLeftRighticon(R.mipmap.ic_hong_news_bg);\n//        }\n//\n//        setTitle(title);\n////        setHasBack();\n        mLayout = (LinearLayout) findViewById(R.id.web_layout);\n\n//        pb = (ProgressBar) findViewById(R.id.service_pb);\n//        pb.setMax(100);\n\n        LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams\n                .MATCH_PARENT);\n\n        mWebView = new Html5WebView(getApplicationContext());\n        mWebView.setLayoutParams(params);\n        mWebView.setWebViewClient(webViewClient);\n        mWebView.getSettings().setCacheMode(WebSettings.LOAD_NO_CACHE);\n        mWebView.getSettings().setJavaScriptEnabled(true);\n        mWebView.getSettings().setDomStorageEnabled(true);\n//        String UserAgentString = mWebView.getSettings().getUserAgentString();\n//        mWebView.getSettings().setUserAgentString(UserAgentString + \"third_program_h5\");\n//        mWebView.getSettings().setUserAgentString(UserAgentString + \"/cjApp\");\n        mWebView.setWebChromeClient(new WebChromeClient() {\n            @Override\n            public boolean onConsoleMessage(ConsoleMessage consoleMessage) {\n                Log.e(TAG, \"msg : \" + consoleMessage.message());\n                return super.onConsoleMessage(consoleMessage);\n            }\n\n            @Override\n            public void onReceivedTitle(WebView view, String title1) {\n                super.onReceivedTitle(view, title);\n            }\n\n        });\n\n\n\n        init(params);\n        getNewsDetail();\n    }\n\n\n    /**\n     * 为富文本添加head,解决加载时字体图片无法适配手机屏幕\n     * @param bodyHTML\n     * @return\n     */\n    private String getHtmlData(String bodyHTML) {\n        String head = \"<head>\"\n                + \"<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0, user-scalable=no\\\"> \"\n                + \"<style>img{max-width: 100%; width:auto; height:auto;}</style>\"\n                + \"</head>\";\n        return \"<html>\" + head + \"<body>\" + bodyHTML + \"</body></html>\";\n    }\n\n\n\n    public void init(LinearLayout.LayoutParams params){\n        RelativeLayout relativeLayout = new RelativeLayout(this);\n        relativeLayout.setLayoutParams(params);\n        relativeLayout.addView(mWebView);\n        RelativeLayout.LayoutParams relparam = new RelativeLayout.LayoutParams(\n                DispUtil.dipToPx(this,40),DispUtil.dipToPx(this,40));\n        relparam.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);\n        relparam.addRule(RelativeLayout.ALIGN_PARENT_RIGHT);\n        relparam.rightMargin = DispUtil.dipToPx(this,20);\n        relparam.bottomMargin = DispUtil.dipToPx(this,50);\n\n        collectBg = new LinearLayout(this);\n        collectBg.setLayoutParams(relparam);\n        collectBg.setGravity(Gravity.CENTER);\n        collectBg.setBackgroundResource(R.drawable.btn_collect_bg);\n\n        collectBtn = new ImageView(this);\n        collectBtn.setBackgroundResource(R.drawable.selector_collect_btn);\n        collectBtn.setLayoutParams(relparam);\n        collectBtn.setOnClickListener(v -> {\n            collect();\n        });\n\n        LinearLayout.LayoutParams bglp = new LinearLayout.LayoutParams(\n                DispUtil.dipToPx(this,20),DispUtil.dipToPx(this,20));\n        collectBtn.setLayoutParams(bglp);\n        collectBg.addView(collectBtn);\n        relativeLayout.addView(collectBg);\n\n        mLayout.addView(relativeLayout);\n    }\n\n\n    public void collect(){\n        String token = SPCache.getString(SPCache.KEY_TOKEN,\"\");\n        if (TextUtils.isEmpty(token)){\n            LoginActivity.instance(this);\n            return;\n        }\n        NewsListModel.DataBean dataBean = (NewsListModel.DataBean) getIntent().getSerializableExtra(\"NewsListModel\");\n        Map<String,Object> param = new HashMap<>();\n        param.put(\"collectionId\",dataBean.getId());\n        param.put(\"token\",token);\n        param.put(\"type\",1);\n\n        Observable observable = collectBtn.isSelected()?\n                InsuranceApiFactory.getmHomeApi().cancelCollection(param)\n                :InsuranceApiFactory.getmHomeApi().addCollection(param);\n        HttpUtils.invoke(this, this, observable,\n                new CallBack<ComModel>() {\n\n                    @Override\n                    public void onResponse(ComModel data) {\n                        ToastUtil.showToast(data.msg);\n                        if (data.code == 1) {\n                            collectBtn.setSelected(!collectBtn.isSelected());\n                        }\n                    }\n                });\n\n\n    }\n\n\n    public void getNewsDetail(){\n        NewsListModel.DataBean dataBean = (NewsListModel.DataBean) getIntent().getSerializableExtra(\"NewsListModel\");\n        Map<String,Object> param = new HashMap<>();\n        if (dataBean!=null) {\n            param.put(\"id\", dataBean.getId());\n        }else {\n            int id = getIntent().getIntExtra(\"id\",0);\n            param.put(\"id\", id);\n            collectBg.setVisibility(View.GONE);\n        }\n        param.put(\"token\",SPCache.getString(SPCache.KEY_TOKEN,\"\"));\n\n        HttpUtils.invoke(this, this, InsuranceApiFactory.getmHomeApi().getNewsdetail(param),\n                new CallBack<NewsDetailModel>() {\n\n                    @Override\n                    public void onResponse(NewsDetailModel data) {\n\n//                        mWebView.loadData(getHtmlData(data.data.content),\"text/html; charset=UTF-8\", null);\n                        //TODO 使用loadDataWithBaseURL解决webview乱码\n                        mWebView.loadDataWithBaseURL(null,data.data.content,\"text/html\", \"UTF-8\", null);\n                        setTitle(data.data.title);\n                        collectBtn.setSelected(data.data.isCollection==1?true:false);\n                    }\n                });\n    }\n\n    @Override\n    protected int getContentLayout() {\n        return R.layout.activity_html5;\n    }\n\n    WebViewClient webViewClient = new WebViewClient() {\n\n        @Override\n        public boolean shouldOverrideUrlLoading(WebView view, String url) {\n//\n////                ToastUtil.showToastLong(\"URL：\" + url);\n////                L.i(\"WebViewClient URL:\" + url);\n//\n//            if (url.startsWith(\"weixin://\")) {\n//                try {\n//                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(url)));\n//                    return true;\n//                } catch (Exception e) {\n//                    // 防止手机没有安装处理某个 scheme 开头的 url 的 APP 导致 crash\n//                    ToastUtils.showShort(\"该手机没有安装微信\");\n//                    return true;\n//                }\n//            } else if (url.startsWith(\"alipays://\") || url.startsWith(\"alipay\")) {\n//                try {\n//                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(url)));\n//                    return true;\n//                } catch (Exception e) {\n//                    // 防止手机没有安装处理某个 scheme 开头的 url 的 APP 导致 crash\n//                    // 启动支付宝 App 失败，会自行跳转支付宝网页支付\n//                    return true;\n//                }\n//            }\n//\n//            // 处理普通 http 请求跳转\n//            if (!(url.startsWith(\"http\") || url.startsWith(\"https\"))) {\n//                return true;\n//            }\n//\n//            // 处理微信 H5 支付跳转时验证请求头 referer 失效\n//            // 验证不通过会出现“商家参数格式有误，请联系商家解决”\n//            if (url.contains(\"wx.tenpay.com\")) {\n//\n//                // 申请微信 H5 支付时填写的域名\n//                // 比如经常用来测试网络连通性的 http://www.baidu.com\n//                String referer = NEWWEIPAYl;\n//\n//                // 兼容 Android 4.4.3 和 4.4.4 两个系统版本设置 referer 无效的问题\n//                if ((\"4.4.3\".equals(Build.VERSION.RELEASE))\n//                        || (\"4.4.4\".equals(Build.VERSION.RELEASE))) {\n//                    if (firstVisitWXH5PayUrl) {\n//                        view.loadDataWithBaseURL(referer, \"<script>window.location.href=\\\"\" + url + \"\\\";</script>\",\n//                                \"text/html\", \"utf-8\", null);\n//                        // 修改标记位状态，避免循环调用\n//                        // 再次进入微信H5支付流程时记得重置状态 firstVisitWXH5PayUrl = true\n//                        firstVisitWXH5PayUrl = false;\n//                    }\n//                    // 返回 false 由系统 WebView 自己处理该 url\n//                    return false;\n//                } else {\n//                    // HashMap 指定容量初始化，避免不必要的内存消耗\n//                    HashMap<String, String> map = new HashMap<>(1);\n//                    map.put(\"Referer\", referer);\n//                    Log.e(\"qqq\", url + \"------\" + referer);\n////                        ToastUtil.showToastLong(\"微信支付：\" + url);\n////                        L.i(\"微信支付URL:\" + url);\n//                    if (url.startsWith(\"https://wx.tenpay.com/cgi-bin/mmpayweb-bin/app.tofans.com\")) {\n//                        return true;\n//                    }\n//                    view.loadUrl(url, map);\n                    return true;\n//                }\n//            }\n//            return false;\n        }\n    };\n\n\n    protected long mOldTime;\n\n    @Override\n    public boolean onKeyDown(int keyCode, KeyEvent event) {\n        if (keyCode == KeyEvent.KEYCODE_BACK) {\n            if (isHuize) {\n                ArticleHtmlActivity.this.finish();\n            } else {\n                if (System.currentTimeMillis() - mOldTime < 500) {\n                    mWebView.clearHistory();\n                    mWebView.loadUrl(mUrl);\n                } else if (mWebView.canGoBack()) {\n                    mWebView.goBack();\n                } else {\n                    ArticleHtmlActivity.this.finish();\n                }\n            }\n\n            mOldTime = System.currentTimeMillis();\n            return true;\n        }\n\n        return super.onKeyDown(keyCode, event);\n    }\n\n\n    @Override\n    protected void onDestroy() {\n        if (mWebView != null) {\n            //清空所有Cookie\n            CookieSyncManager.createInstance(this);  //Create a singleton CookieSyncManager within a context\n            CookieManager cookieManager = CookieManager.getInstance(); // the singleton CookieManager instance\n            cookieManager.removeAllCookie();// Removes all cookies.\n\n            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n                cookieManager.flush();\n            } else {\n                CookieSyncManager.createInstance(this);\n                CookieSyncManager.getInstance().sync();\n            }\n\n            mWebView.setWebChromeClient(null);\n            mWebView.setWebViewClient(null);\n            mWebView.removeAllViews();\n            mWebView.getSettings().setJavaScriptEnabled(false);\n            mWebView.clearCache(true);\n            mWebView.clearFormData();\n\n            mWebView.loadDataWithBaseURL(null, \"\", \"text/html\", \"utf-8\", null);\n            mWebView.clearHistory();\n            ((ViewGroup) mWebView.getParent()).removeView(mWebView);\n            mWebView.destroy();\n            mWebView = null;\n        }\n\n        super.onDestroy();\n    }\n\n    @Override\n    public void onClick(View view) {\n//        if (view.getId() == R.id.iv_custom_toolbar_left || view.getId() == R.id.tv_custom_toolbar_left) {\n//            if (isHuize) {\n//                ArticleHtmlActivity.this.finish();\n//                return;\n//            }\n//            if (System.currentTimeMillis() - mOldTime < 500) {\n//                mWebView.clearHistory();\n//                mWebView.loadUrl(mUrl);\n//            } else if (mWebView.canGoBack()) {\n//                mWebView.goBack();\n//            } else {\n//                ArticleHtmlActivity.this.finish();\n//            }\n//            mOldTime = System.currentTimeMillis();\n//        } else if (view.getId() == R.id.iv_custom_toolbar_right) {\n////            ToastUtil.showToast(\"分享\");\n//            getPermission();\n//        } else if (view.getId() == R.id.iv_custom_toolbar_left_right) {\n////            showActivity(Html5Activity.this, MessageListActivity.class);\n//        }\n    }\n\n\n    public static void newIntent(Context mContext, NewsListModel.DataBean dataBean) {\n        Intent intent = new Intent(mContext, ArticleHtmlActivity.class);\n        intent.putExtra(\"NewsListModel\",dataBean);\n        mContext.startActivity(intent);\n    }\n\n\n    public static void newIntent(Context mContext, int id) {\n        Intent intent = new Intent(mContext, ArticleHtmlActivity.class);\n        intent.putExtra(\"id\",id);\n        mContext.startActivity(intent);\n    }\n\n\n\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/java/com/gzhealthy/health/activity/ArticleHtmlActivity.java	(revision fe91bb5002047716f8a0102186ec44568619e2da)
+++ app/src/main/java/com/gzhealthy/health/activity/ArticleHtmlActivity.java	(date 1630492981000)
@@ -2,7 +2,6 @@
 
 import android.content.Context;
 import android.content.Intent;
-import android.graphics.BitmapFactory;
 import android.os.Build;
 import android.os.Bundle;
 import android.text.TextUtils;
@@ -36,7 +35,6 @@
 import com.gzhealthy.health.tool.SPCache;
 import com.gzhealthy.health.utils.DispUtil;
 import com.gzhealthy.health.utils.ToastUtil;
-import com.gzhealthy.health.utils.WechatPlatform;
 import com.gzhealthy.health.widget.Html5WebView;
 
 import java.io.File;
@@ -45,8 +43,6 @@
 
 import rx.Observable;
 
-import static org.litepal.crud.DataSupport.findFirst;
-
 /**
  * 资讯详情浏览
  */
